<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web DAW</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-title">Rewired DAW</div>
    <div class="sidebar-subtitle">Make the music you love</div>
    <div id="sidebar-loops"></div>
    
    <!-- Search Bar -->
    <div class="sidebar-search-container">
      <input type="text" id="sidebar-search" class="sidebar-search-input" placeholder="Search (Kicks, Claps...)" aria-label="Search sidebar">
      <button id="sidebar-search-clear" class="sidebar-search-clear" aria-label="Clear search" style="display: none;">
        <svg viewBox="0 0 14 14" aria-hidden="true" focusable="false">
          <line x1="1" y1="1" x2="13" y2="13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <line x1="13" y1="1" x2="1" y2="13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    
    <!-- Audio Preview Container -->
    <div id="audio-preview" class="audio-preview hidden">
      <div class="audio-preview-header">
        <div class="audio-preview-filename"></div>
        <div class="audio-preview-controls">
          <button id="audio-preview-play" class="audio-preview-btn" aria-label="Play preview">
            <svg viewBox="0 0 14 14" aria-hidden="true" focusable="false">
              <polygon points="4,2 12,7 4,12" />
            </svg>
          </button>
          <button id="audio-preview-stop" class="audio-preview-btn" aria-label="Stop preview">
            <svg viewBox="0 0 14 14" aria-hidden="true" focusable="false">
              <rect x="4" y="4" width="6" height="6" />
            </svg>
          </button>
        </div>
      </div>
      <div class="audio-preview-waveform" id="audio-preview-waveform">
        <canvas id="audio-preview-canvas" class="audio-preview-canvas"></canvas>
        <div id="audio-preview-playhead" class="audio-preview-playhead hidden"></div>
      </div>
    </div>

    <!-- MIDI Preview Container -->
    <div id="midi-preview" class="audio-preview hidden">
      <div class="audio-preview-header">
        <div class="audio-preview-filename"></div>
        <div class="audio-preview-controls">
          <button id="midi-preview-play" class="audio-preview-btn" aria-label="Play MIDI preview">
            <svg viewBox="0 0 14 14" aria-hidden="true" focusable="false">
              <polygon points="4,2 12,7 4,12" />
            </svg>
          </button>
          <button id="midi-preview-stop" class="audio-preview-btn" aria-label="Stop MIDI preview">
            <svg viewBox="0 0 14 14" aria-hidden="true" focusable="false">
              <rect x="4" y="4" width="6" height="6" />
            </svg>
          </button>
        </div>
      </div>
      <div class="audio-preview-waveform" id="midi-preview-waveform">
        <canvas id="midi-preview-canvas" class="audio-preview-canvas"></canvas>
        <div id="midi-preview-playhead" class="audio-preview-playhead hidden"></div>
      </div>
    </div>
  </div>



  <div class="main">
<div class="top-bar">

  <!-- FILE MENU -->
  <div class="menu-item" id="fileMenu">
    File ▾
    <div class="dropdown" id="fileDropdown">
      <div class="dropdown-item" id="newProjectBtn">New Project</div>
      <div class="dropdown-item" id="saveProjectBtn">Save</div>
      <div class="dropdown-item" id="loadProjectBtn">Load</div>
      <div class="dropdown-item" id="exportBtn">Export WAV</div>
    </div>
  </div>
  <input type="file" id="projectFileInput" accept=".zip" style="display:none;">
  <!-- TRANSPORT -->
  <button id="playToggleBtn" class="transport-btn play">Play</button>

  <!-- TEMPO -->
  <label class="tempo-text" style="margin-left:20px;">Tempo:</label>
  <input id="tempoSlider" class="tempo-slider" type="range" min="100" max="200" value="175" step="1" style="display:none;">
  <div id="tempoBox" class="tempo-box" data-tempo="175">
    <div class="tempo-box-value">175</div>
  </div>

  <!-- MASTER VOLUME -->
  <label class="master-volume-text" style="margin-left:20px;">Master:</label>
  <input id="masterVolumeSlider" class="tempo-slider" type="range" min="0" max="1" value="0.8" step="0.01">

  <!-- VU METERS -->
  <div class="master-vu-horizontal">
    <canvas id="vuLeft" width="80" height="6"></canvas>
    <canvas id="vuRight" width="80" height="6"></canvas>
  </div>



  <!-- SNAP AND CLIP CONTROLS -->
  <div style="margin-left: 0px; background: #232323; border-radius: 4px; padding: 4px 8px 4px 4px; display: flex; align-items: center; gap: 12px;">
    
    <!-- === INSERTED: Timeline Tool Buttons (independent from piano roll) === -->
  <div id="timeline-tools" style="display: flex; align-items: center; gap: 8px; margin-left: 12px;">
    <!-- Pencil -->
    <button class="transpose-btn timeline-tool-btn" title="Draw (Pencil)">
      <svg id="Pencil_24" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <rect width="24" height="24" stroke="none" fill="#000000" opacity="0"/>
        <g transform="matrix(0.78 0 0 0.78 12 12)">
          <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" translate(-12.93, -13.07)" d="M 20.09375 0.25 C 19.5 0.246094 18.917969 0.457031 18.46875 0.90625 L 17.46875 1.9375 L 24.0625 8.5625 L 25.0625 7.53125 C 25.964844 6.628906 25.972656 5.164063 25.0625 4.25 L 21.75 0.9375 C 21.292969 0.480469 20.6875 0.253906 20.09375 0.25 Z M 16.34375 2.84375 L 14.78125 4.34375 L 21.65625 11.21875 L 23.25 9.75 Z M 13.78125 5.4375 L 2.96875 16.15625 C 2.71875 16.285156 2.539063 16.511719 2.46875 16.78125 L 0.15625 24.625 C 0.0507813 24.96875 0.144531 25.347656 0.398438 25.601563 C 0.652344 25.855469 1.03125 25.949219 1.375 25.84375 L 9.21875 23.53125 C 9.582031 23.476563 9.882813 23.222656 10 22.875 L 20.65625 12.3125 L 18 9.65625 L 17.96875 9.65625 L 16.1875 7.84375 Z M 4.15625 17.9375 L 4.6875 18.46875 L 7.28125 18.6875 L 7.40625 21.21875 L 8.0625 21.875 L 3.84375 23.09375 L 2.90625 22.15625 Z" stroke-linecap="round" />
        </g>
      </svg>
    </button>
    <!-- Select Box -->
    <button class="transpose-btn timeline-tool-btn" title="Select (Box)">
      <svg id="Interface_Edit_Select_Area_Rectangle_Dash_24" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <rect width="24" height="24" stroke="none" fill="#000000" opacity="0"/>
        <g transform="matrix(1.43 0 0 1.43 12 12)">
          <g>
            <g transform="matrix(1 0 0 1 5.5 -5.5)">
              <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12.5, -1.5)" d="M 11.5 0.5 L 12.5 0.5 C 13.052284749830793 0.5 13.5 0.9477152501692063 13.5 1.4999999999999998 L 13.5 2.5" stroke-linecap="round" />
            </g>
            <g transform="matrix(1 0 0 1 -5.5 -5.5)">
              <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-1.5, -1.5)" d="M 0.5 2.5 L 0.5 1.5 C 0.5 0.9477152501692065 0.9477152501692065 0.5 1.5 0.5 L 2.5 0.5" stroke-linecap="round" />
            </g>
            <g transform="matrix(1 0 0 1 0 -6.5)">
              <line style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" x1="-1.5" y1="0" x2="1.5" y2="0" />
            </g>
            <g transform="matrix(1 0 0 1 6.5 0)">
              <line style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" x1="0" y1="-1.5" x2="0" y2="1.5" />
            </g>
            <g transform="matrix(1 0 0 1 -6.5 0)">
              <line style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" x1="0" y1="-1.5" x2="0" y2="1.5" />
            </g>
            <g transform="matrix(1 0 0 1 5.5 5.5)">
              <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12.5, -12.5)" d="M 11.5 13.5 L 12.5 13.5 C 13.052284749830793 13.5 13.5 13.052284749830793 13.5 12.5 L 13.5 11.5" stroke-linecap="round" />
            </g>
            <g transform="matrix(1 0 0 1 -5.5 5.5)">
              <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-1.5, -12.5)" d="M 0.5 11.5 L 0.5 12.5 C 0.5 13.052284749830793 0.9477152501692065 13.5 1.5 13.5 L 2.5 13.5" stroke-linecap="round" />
            </g>
            <g transform="matrix(1 0 0 1 0 6.5)">
              <line style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" x1="-1.5" y1="0" x2="1.5" y2="0" />
            </g>
          </g>
        </g>
      </svg>
    </button>
    <!-- Slice -->
    <button class="transpose-btn timeline-tool-btn" title="Slice">
      <svg id="Scissors_24" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <rect width="24" height="24" stroke="none" fill="#000000" opacity="0"/>
        <g transform="matrix(0.77 0 0 0.77 12 12)">
          <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" translate(-15, -15)" d="M 15.195312 2.0019531 C 15.059656 2.011375 14.924281 2.0576406 14.800781 2.1503906 L 13.199219 3.3515625 C 12.444219 3.9185625 12 4.8079531 12 5.7519531 L 12 12 L 16 12 L 16 2.7519531 C 16 2.2884531 15.602281 1.9736875 15.195312 2.0019531 z M 25 4 C 24.447715250169207 4 24 4.447715250169207 24 5 C 24 5.552284749830793 24.447715250169207 6 25 6 C 25.552284749830793 6 26 5.552284749830793 26 5 C 26 4.447715250169207 25.552284749830793 4 25 4 z M 22 7 C 21.447715250169207 7 21 7.447715250169207 21 8 C 21 8.552284749830793 21.447715250169207 9 22 9 C 22.552284749830793 9 23 8.552284749830793 23 8 C 23 7.447715250169207 22.552284749830793 7 22 7 z M 19 10 C 18.447715250169207 10 18 10.447715250169207 18 11 C 18 11.552284749830793 18.447715250169207 12 19 12 C 19.552284749830793 12 20 11.552284749830793 20 11 C 20 10.447715250169207 19.552284749830793 10 19 10 z M 6 12 C 3.829 12 2 13.829 2 16 C 2 18.171 3.829 20 6 20 C 7.4445819 20 8.7240824 19.181518 9.4277344 18 L 12 18 L 12 20.572266 C 10.818482 21.275918 10 22.555418 10 24 C 10 26.171 11.829 28 14 28 C 16.171 28 18 26.171 18 24 C 18 22.555418 17.181518 21.275918 16 20.572266 L 16 18 L 24.248047 18 C 25.192047 18 26.081438 17.555781 26.648438 16.800781 L 27.849609 15.199219 C 28.220609 14.705219 27.866047 14 27.248047 14 L 9.4277344 14 C 8.7240824 12.818482 7.4445819 12 6 12 z M 6 14 C 7.067 14 8 14.933 8 16 C 8 17.067 7.067 18 6 18 C 4.933 18 4 17.067 4 16 C 4 14.933 4.933 14 6 14 z M 14 15 C 14.552 15 15 15.448 15 16 C 15 16.552 14.552 17 14 17 C 13.448 17 13 16.552 13 16 C 13 15.448 13.448 15 14 15 z M 14 22 C 15.067 22 16 22.933 16 24 C 16 25.067 15.067 26 14 26 C 12.933 26 12 25.067 12 24 C 12 22.933 12.933 22 14 22 z" stroke-linecap="round" />
        </g>
      </svg>
    </button>
    <!-- Fade -->
    <button class="transpose-btn timeline-tool-btn" title="Fade">
      <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
        <path fill="currentColor" d="M3 15 L3 3 L15 15 Z"/>
      </svg>
    </button>
  </div>
  <!-- === END timeline-tools buttons === --> 
    <!-- SNAP CONTROL -->
    <div id="snapControl" style="display: flex; align-items: center; gap: 8px;">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #888;">
        <path d="M12 2L12 22M8 6L12 2L16 6M8 18L12 22L16 18M2 12L22 12M6 8L2 12L6 16M18 8L22 12L18 16"/>
      </svg>
      <select id="snapValue" style="padding: 4px 8px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 3px; cursor: pointer;">
        <option value="0">None</option>
        <option value="0.25">1 Beat</option>
        <option value="0.5">2 Beats</option>
        <option value="1" selected>1 Bar</option>
        <option value="2">2 Bars</option>
        <option value="4">4 Bars</option>
      </select>
    </div>

    <!-- CLIP LIST DROPDOWN -->
    <div id="clipListControl" style="display: flex; align-items: center; gap: 8px; min-width: 160px; max-width: 160px;">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #888;">
        <circle cx="12" cy="12" r="10"/>
        <rect x="8" y="8" width="8" height="8" rx="2"/>
      </svg>
      <select id="clipListDropdown" style="padding: 4px 8px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 3px; cursor: pointer; width: 140px; min-width: 140px; max-width: 140px;">
        <option value="">No clips</option>
      </select>
    </div>
  </div>
</div>





<div class="timeline" id="timeline">
  <div id="timeline-bar"></div>
  <div id="seekMarker" class="seek-marker"></div>

  <!-- ⭐ NEW: Wrapper for controls + timeline -->
  <div id="timeline-wrapper">
    <!-- ⭐ NEW: Fixed track controls column -->
    <div id="track-controls-column"></div>
    
    <!-- ⭐ MODIFIED: Timeline scroll now only contains track-inner areas -->
    <div id="timeline-scroll">
      <div id="playhead" class="hidden"></div>
      <div class="tracks" id="tracks">
        
      </div>
    </div>
  </div>
</div>


<div id="piano-roll-container" class="hidden">

  <div id="piano-roll-sample-header">
    <!-- LEFT -->
    <div class="piano-roll-header-left">
      
      <span class="strong-label">
        <span id="piano-roll-clip-name"></span>
        Sample: <strong id="piano-roll-sample-name">None</strong>
      </span>
      <button id="piano-roll-load-sample">Load Sample</button>
    </div>

    <!-- CENTER -->
    <div class="piano-roll-header-center">
      <!-- ⭐ TOOL ICON BUTTONS (Pencil, Select, Slice) -->
      <div id="piano-roll-tools" style="display: flex; align-items: center; gap: 8px; margin-right: 18px;">
        <!-- Pencil -->
        <button class="transpose-btn piano-roll-tool-btn" title="Draw (Pencil)">
          <svg id="Pencil_24" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect width="24" height="24" stroke="none" fill="#000000" opacity="0"/>
            <g transform="matrix(0.78 0 0 0.78 12 12)">
              <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" translate(-12.93, -13.07)" d="M 20.09375 0.25 C 19.5 0.246094 18.917969 0.457031 18.46875 0.90625 L 17.46875 1.9375 L 24.0625 8.5625 L 25.0625 7.53125 C 25.964844 6.628906 25.972656 5.164063 25.0625 4.25 L 21.75 0.9375 C 21.292969 0.480469 20.6875 0.253906 20.09375 0.25 Z M 16.34375 2.84375 L 14.78125 4.34375 L 21.65625 11.21875 L 23.25 9.75 Z M 13.78125 5.4375 L 2.96875 16.15625 C 2.71875 16.285156 2.539063 16.511719 2.46875 16.78125 L 0.15625 24.625 C 0.0507813 24.96875 0.144531 25.347656 0.398438 25.601563 C 0.652344 25.855469 1.03125 25.949219 1.375 25.84375 L 9.21875 23.53125 C 9.582031 23.476563 9.882813 23.222656 10 22.875 L 20.65625 12.3125 L 18 9.65625 L 17.96875 9.65625 L 16.1875 7.84375 Z M 4.15625 17.9375 L 4.6875 18.46875 L 7.28125 18.6875 L 7.40625 21.21875 L 8.0625 21.875 L 3.84375 23.09375 L 2.90625 22.15625 Z" stroke-linecap="round" />
            </g>
          </svg>
        </button>
        <!-- Select Box -->
        <button class="transpose-btn piano-roll-tool-btn" title="Select (Box)">
          <svg id="Interface_Edit_Select_Area_Rectangle_Dash_24" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect width="24" height="24" stroke="none" fill="#000000" opacity="0"/>
            <g transform="matrix(1.43 0 0 1.43 12 12)">
              <g>
                <g transform="matrix(1 0 0 1 5.5 -5.5)">
                  <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12.5, -1.5)" d="M 11.5 0.5 L 12.5 0.5 C 13.052284749830793 0.5 13.5 0.9477152501692063 13.5 1.4999999999999998 L 13.5 2.5" stroke-linecap="round" />
                </g>
                <g transform="matrix(1 0 0 1 -5.5 -5.5)">
                  <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-1.5, -1.5)" d="M 0.5 2.5 L 0.5 1.5 C 0.5 0.9477152501692065 0.9477152501692065 0.5 1.5 0.5 L 2.5 0.5" stroke-linecap="round" />
                </g>
                <g transform="matrix(1 0 0 1 0 -6.5)">
                  <line style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" x1="-1.5" y1="0" x2="1.5" y2="0" />
                </g>
                <g transform="matrix(1 0 0 1 6.5 0)">
                  <line style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" x1="0" y1="-1.5" x2="0" y2="1.5" />
                </g>
                <g transform="matrix(1 0 0 1 -6.5 0)">
                  <line style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" x1="0" y1="-1.5" x2="0" y2="1.5" />
                </g>
                <g transform="matrix(1 0 0 1 5.5 5.5)">
                  <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12.5, -12.5)" d="M 11.5 13.5 L 12.5 13.5 C 13.052284749830793 13.5 13.5 13.052284749830793 13.5 12.5 L 13.5 11.5" stroke-linecap="round" />
                </g>
                <g transform="matrix(1 0 0 1 -5.5 5.5)">
                  <path style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-1.5, -12.5)" d="M 0.5 11.5 L 0.5 12.5 C 0.5 13.052284749830793 0.9477152501692065 13.5 1.5 13.5 L 2.5 13.5" stroke-linecap="round" />
                </g>
                <g transform="matrix(1 0 0 1 0 6.5)">
                  <line style="stroke: currentColor; stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" x1="-1.5" y1="0" x2="1.5" y2="0" />
                </g>
              </g>
            </g>
          </svg>
        </button>
        <!-- Slice -->
        <button class="transpose-btn piano-roll-tool-btn" title="Slice">
          <svg id="Scissors_24" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect width="24" height="24" stroke="none" fill="#000000" opacity="0"/>
            <g transform="matrix(0.77 0 0 0.77 12 12)">
              <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" translate(-15, -15)" d="M 15.195312 2.0019531 C 15.059656 2.011375 14.924281 2.0576406 14.800781 2.1503906 L 13.199219 3.3515625 C 12.444219 3.9185625 12 4.8079531 12 5.7519531 L 12 12 L 16 12 L 16 2.7519531 C 16 2.2884531 15.602281 1.9736875 15.195312 2.0019531 z M 25 4 C 24.447715250169207 4 24 4.447715250169207 24 5 C 24 5.552284749830793 24.447715250169207 6 25 6 C 25.552284749830793 6 26 5.552284749830793 26 5 C 26 4.447715250169207 25.552284749830793 4 25 4 z M 22 7 C 21.447715250169207 7 21 7.447715250169207 21 8 C 21 8.552284749830793 21.447715250169207 9 22 9 C 22.552284749830793 9 23 8.552284749830793 23 8 C 23 7.447715250169207 22.552284749830793 7 22 7 z M 19 10 C 18.447715250169207 10 18 10.447715250169207 18 11 C 18 11.552284749830793 18.447715250169207 12 19 12 C 19.552284749830793 12 20 11.552284749830793 20 11 C 20 10.447715250169207 19.552284749830793 10 19 10 z M 6 12 C 3.829 12 2 13.829 2 16 C 2 18.171 3.829 20 6 20 C 7.4445819 20 8.7240824 19.181518 9.4277344 18 L 12 18 L 12 20.572266 C 10.818482 21.275918 10 22.555418 10 24 C 10 26.171 11.829 28 14 28 C 16.171 28 18 26.171 18 24 C 18 22.555418 17.181518 21.275918 16 20.572266 L 16 18 L 24.248047 18 C 25.192047 18 26.081438 17.555781 26.648438 16.800781 L 27.849609 15.199219 C 28.220609 14.705219 27.866047 14 27.248047 14 L 9.4277344 14 C 8.7240824 12.818482 7.4445819 12 6 12 z M 6 14 C 7.067 14 8 14.933 8 16 C 8 17.067 7.067 18 6 18 C 4.933 18 4 17.067 4 16 C 4 14.933 4.933 14 6 14 z M 14 15 C 14.552 15 15 15.448 15 16 C 15 16.552 14.552 17 14 17 C 13.448 17 13 16.552 13 16 C 13 15.448 13.448 15 14 15 z M 14 22 C 15.067 22 16 22.933 16 24 C 16 25.067 15.067 26 14 26 C 12.933 26 12 25.067 12 24 C 12 22.933 12.933 22 14 22 z" stroke-linecap="round" />
            </g>
          </svg>
        </button>
        <!-- Fade -->
        <button class="transpose-btn piano-roll-tool-btn" title="Fade">
          <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
            <path fill="currentColor" d="M3 15 L3 3 L15 15 Z"/>
          </svg>
        </button>
      </div>
      <div id="piano-roll-reverb-control">
        <span class="soft-label"><label>Reverb:</label></span>
        <input type="range" class="tempo-slider" id="piano-roll-reverb" min="0" max="1" step="0.01">
      </div>
    </div>
    <!-- RIGHT -->
    <div class="piano-roll-header-right">
      <!-- Piano Roll Preview Controls -->
      <div class="piano-roll-preview-controls" style="display: flex; align-items: center; gap: 8px;">
        <button id="piano-roll-preview-play" class="transpose-btn" title="Play Preview" aria-label="Play piano roll preview">
          <svg viewBox="0 0 14 14" width="16" height="16" aria-hidden="true" focusable="false">
            <polygon points="4,2 12,7 4,12" fill="currentColor" />
          </svg>
        </button>
        <button id="piano-roll-preview-stop" class="transpose-btn" title="Stop Preview" aria-label="Stop piano roll preview">
          <svg viewBox="0 0 14 14" width="16" height="16" aria-hidden="true" focusable="false">
            <rect x="4" y="4" width="6" height="6" fill="currentColor" />
          </svg>
        </button>
      </div>


      <!-- ⭐ NEW: Scale selector -->

      <div id="piano-roll-transpose">
        <div class="transpose-group">
          <span class="soft-label">Semi</span>
          <button class="transpose-btn" data-step="-1">▼</button>
          <button class="transpose-btn" data-step="1">▲</button>
        </div>

        <div class="transpose-group">
          <span class="soft-label">Oct</span>
          <button class="transpose-btn" data-step="-12">▼</button>
          <button class="transpose-btn" data-step="12">▲</button>
        </div>
      </div>

      <div id="piano-roll-scale-control" style="display: flex; align-items: center; gap: 0px;">
        <span class="soft-label" style="margin-right:8px;"><label>Scale:</label></span>
        <select id="piano-roll-scale" class="custom-scrollbar">
          <option value="none">None</option>
          <optgroup label="Major">
            <option value="C-major">C Major</option>
            <option value="C#-major">C# Major</option>
            <option value="D-major">D Major</option>
            <option value="D#-major">D# Major</option>
            <option value="E-major">E Major</option>
            <option value="F-major">F Major</option>
            <option value="F#-major">F# Major</option>
            <option value="G-major">G Major</option>
            <option value="G#-major">G# Major</option>
            <option value="A-major">A Major</option>
            <option value="A#-major">A# Major</option>
            <option value="B-major">B Major</option>
          </optgroup>
          <optgroup label="Minor">
            <option value="A-minor">A Minor</option>
            <option value="A#-minor">A# Minor</option>
            <option value="B-minor">B Minor</option>
            <option value="C-minor">C Minor</option>
            <option value="C#-minor">C# Minor</option>
            <option value="D-minor">D Minor</option>
            <option value="D#-minor">D# Minor</option>
            <option value="E-minor">E Minor</option>
            <option value="F-minor">F Minor</option>
            <option value="F#-minor">F# Minor</option>
            <option value="G-minor">G Minor</option>
            <option value="G#-minor">G# Minor</option>
          </optgroup>
        </select>
        <!-- Magnet Toggle Button (moved here) -->
        <button id="piano-roll-magnet-toggle" class="transpose-btn piano-roll-tool-btn" title="Snap (Magnet)" aria-pressed="false" style="margin-left: 8px;">
          <svg id="Magnet_24" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect width="24" height="24" stroke="none" fill="#000000" opacity="0"/>
            <g transform="matrix(0.87 0 0 0.87 12 12)">
              <path style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-dashoffset: 0; stroke-linejoin: miter; stroke-miterlimit: 4; fill: currentColor; fill-rule: nonzero; opacity: 1;" transform=" translate(-15, -14.5)" d="M 15 3 C 14.877437426322079 3.0019810306976975 14.756283244581198 3.0264766678885078 14.642578 3.0722656000000006 C 8.7535588 3.2725798 4 8.0632579 4 14 L 4 25 C 4.0000552179053495 25.55226187620846 4.447738123791541 25.99994478209465 5 26 L 11 26 C 11.552261876208458 25.99994478209465 11.999944782094651 25.55226187620846 12 25 L 12 14 C 12 12.331516 13.331516 11 15 11 C 16.668484 11 18 12.331516 18 14 L 18 25 C 18.00005521790535 25.55226187620846 18.44773812379154 25.99994478209465 19 26 L 25 26 C 25.55226187620846 25.99994478209465 25.99994478209465 25.55226187620846 26 25 L 26 14 C 26 7.9365932 21.063407 3 15 3 z M 6 21 L 10 21 L 10 24 L 6 24 L 6 21 z M 20 21 L 24 21 L 24 24 L 20 24 L 20 21 z" stroke-linecap="round" />
            </g>
          </svg>
        </button>
      </div>


    
      

      <button id="piano-roll-close">×</button>
    </div>
  </div>

  <!-- ⭐ NEW: fixed piano canvas -->
  <div id="piano-roll-piano">
    <canvas id="piano-roll-piano-canvas"></canvas>
  </div>

  <!-- ⭐ Scrolling grid canvas -->
  <div id="piano-roll-scroll">
    <canvas id="piano-roll-canvas"></canvas>
  </div>

</div>


<!-- Export Settings Dialog -->
<div id="export-dialog" class="export-dialog hidden">
  <div class="export-dialog-overlay"></div>
  <div class="export-dialog-content">
    <div class="export-dialog-header">
      <h2>Export Settings</h2>
      <button id="export-dialog-close" class="export-dialog-close" aria-label="Close">×</button>
    </div>
    
    <div class="export-dialog-body">
      <div class="export-preset-section">
        <label class="export-label">Select Render Preset:</label>
        
        <div class="export-preset-option">
          <input type="radio" id="preset-premaster" name="exportPreset" value="premaster" checked>
          <label for="preset-premaster" class="export-preset-label">
            <div class="export-preset-icon">
              <svg viewBox="0 0 122.88 92.04" xmlns="http://www.w3.org/2000/svg">
                <path fill="currentColor" d="M90.14,23.41a5.14,5.14,0,0,1,8.78-3.63h0a5.13,5.13,0,0,1,1.51,3.63V68.69a5.14,5.14,0,0,1-8.78,3.64h0a5.12,5.12,0,0,1-1.51-3.63V23.41ZM0,18.22a5.12,5.12,0,0,1,1.51-3.63h0a5.15,5.15,0,0,1,8.78,3.64V73.83a5.16,5.16,0,0,1-1.51,3.64h0A5.15,5.15,0,0,1,0,73.83V18.22ZM22.59,5.14a5.13,5.13,0,0,1,1.5-3.63h0a5.14,5.14,0,0,1,8.77,3.63V86.9a5.14,5.14,0,0,1-8.77,3.64h0a5.11,5.11,0,0,1-1.5-3.63V5.14ZM67.64,33.93a5.13,5.13,0,0,1,1.5-3.63h0a5.14,5.14,0,0,1,7.26,0h0a5.14,5.14,0,0,1,1.5,3.63V58.16a5.15,5.15,0,0,1-1.5,3.64h0a5.13,5.13,0,0,1-7.26,0h0a5.11,5.11,0,0,1-1.5-3.63V33.93ZM45.13,18.25a5.14,5.14,0,0,1,1.51-3.64h0a5.15,5.15,0,0,1,8.78,3.64V73.86a5.12,5.12,0,0,1-1.51,3.63h0a5.15,5.15,0,0,1-8.78-3.64V18.25ZM112.7,12a5.09,5.09,0,0,1,1.49-3.61l.11-.1a5,5,0,0,1,7.1.1A5.13,5.13,0,0,1,122.88,12v68a5.17,5.17,0,0,1-1.48,3.62l-.11.1a5,5,0,0,1-7.1-.1,5.14,5.14,0,0,1-1.49-3.62V12Z"/>
              </svg>
            </div>
            <div class="export-preset-title">Pre-Master (-6dB)</div>
            <div class="export-preset-desc">Normalize to -6dB, no limiting or mastering effects. Perfect for further processing.</div>
          </label>
        </div>
        
        <div class="export-preset-option">
          <input type="radio" id="preset-clubmaster" name="exportPreset" value="clubmaster">
          <label for="preset-clubmaster" class="export-preset-label">
            <div class="export-preset-icon">
              <svg viewBox="0 0 115.618 122.88" xmlns="http://www.w3.org/2000/svg">
                <g>
                  <path fill="currentColor" fill-rule="evenodd" d="M16.151,0L16.151,0c5.292,0,9.621,4.33,9.621,9.622v21.595 c-2.864-1.43-6.095-2.236-9.514-2.236c-3.504,0-6.811,0.845-9.728,2.342V9.622C6.53,4.33,10.859,0,16.151,0L16.151,0z M99.36,34.06 c8.979,0,16.258,7.278,16.258,16.257c0,8.979-7.279,16.258-16.258,16.258s-16.257-7.278-16.257-16.258 C83.104,41.338,90.382,34.06,99.36,34.06L99.36,34.06z M99.254,0L99.254,0c5.292,0,9.621,4.33,9.621,9.622v21.595 c-2.864-1.43-6.095-2.236-9.515-2.236c-3.504,0-6.811,0.845-9.728,2.342V9.622C89.633,4.33,93.962,0,99.254,0L99.254,0z M108.875,69.417v43.842c0,5.291-4.329,9.621-9.621,9.621l0,0c-5.292,0-9.621-4.33-9.621-9.621V69.312 c2.917,1.496,6.224,2.341,9.728,2.341C102.78,71.652,106.011,70.847,108.875,69.417L108.875,69.417z M57.617,93.896 c8.979,0,16.257-7.278,16.257-16.257c0-8.979-7.278-16.258-16.257-16.258c-8.979,0-16.257,7.278-16.257,16.258 C41.36,86.617,48.638,93.896,57.617,93.896L57.617,93.896z M57.51,122.88L57.51,122.88c5.292,0,9.622-4.331,9.622-9.621V96.689 c-2.864,1.43-6.053,2.236-9.515,2.236s-6.811-0.846-9.728-2.343v16.676C47.89,118.55,52.219,122.88,57.51,122.88L57.51,122.88z M67.132,58.489V9.622C67.132,4.331,62.802,0,57.51,0l0,0c-5.292,0-9.621,4.33-9.621,9.622v48.974 c2.917-1.497,6.266-2.343,9.728-2.343S64.268,57.06,67.132,58.489L67.132,58.489z M16.257,34.06 c8.979,0,16.257,7.278,16.257,16.257c0,8.979-7.278,16.258-16.257,16.258C7.279,66.574,0,59.296,0,50.316 C0,41.338,7.279,34.06,16.257,34.06L16.257,34.06z M25.771,69.417v43.842c0,5.291-4.329,9.621-9.621,9.621l0,0 c-5.292,0-9.621-4.33-9.621-9.621V69.312c2.917,1.496,6.224,2.341,9.728,2.341C19.677,71.652,22.907,70.847,25.771,69.417 L25.771,69.417z"/>
                </g>
              </svg>
            </div>
            <div class="export-preset-title">Club Master</div>
            <div class="export-preset-desc">3-band EQ for tonal balance, gentle glue compression (2:1), clean saturation (10%), brick-wall limiter with aggressive makeup gain. Loud, punchy, club-ready.</div>
          </label>
        </div>
        
        <div class="export-preset-option">
          <input type="radio" id="preset-streaming" name="exportPreset" value="streaming">
          <label for="preset-streaming" class="export-preset-label">
            <div class="export-preset-icon">
              <svg viewBox="0 0 512 425.3" xmlns="http://www.w3.org/2000/svg">
                <path fill="currentColor" d="M256 196c63.31 0 114.65 51.33 114.65 114.65 0 63.32-51.34 114.65-114.65 114.65-63.32 0-114.65-51.33-114.65-114.65C141.35 247.33 192.68 196 256 196zm103.79-71.3c-3.13 1.55-6.3 3.25-9.42 5.05-9.37 5.49-18.63 12.21-28.08 19.92l-20.17-23.09c6.96-6.45 14.5-12.33 22.5-17.53 6.37-4.17 13.04-7.88 19.92-11.05 2.75-1.38 5.5-2.67 8.33-3.87-13.29-23.55-32.42-40.42-54.09-50.83-43.06-20.62-96.68-16.14-134.61 13.32-21.79 16.88-38.33 42.13-44.71 75.59l-2 10.45-10.42 1.84c-10.21 1.79-19.32 4.25-27.33 7.38-7.75 3-14.66 6.71-20.7 11.08-4.84 3.5-9.01 7.42-12.54 11.66-10.97 13.13-16.05 29.58-15.93 46.26.13 16.9 5.63 33.99 15.8 48.03 3.79 5.21 8.16 10.01 13.16 14.17 5.09 4.2 10.79 7.71 17.21 10.34 6.37 2.62 13.42 4.49 21.21 5.58h11.34c-.31 3.84-.46 7.73-.46 11.64 0 6.45.41 12.8 1.22 19.02h-12.6l-1.92-.16c-11.12-1.42-21.21-4.05-30.37-7.83-9.46-3.93-17.84-8.96-25.21-15.13-7-5.83-13.12-12.46-18.33-19.67C7.67 267.71.17 244.29 0 220.95c-.16-23.58 7.17-47.03 23.01-66.04 5.12-6.16 11.15-11.82 18.07-16.83 8.05-5.83 17.25-10.75 27.68-14.78 7.16-2.8 14.82-5.14 22.91-7.01 9.17-36.41 28.71-64.45 53.83-83.91C192.57-4.1 258.61-9.92 312.04 15.75c29.2 14.05 54.7 37.42 71.25 70.29 6.66-1.04 13.33-1.58 19.95-1.5 69.26.52 109.46 59.53 108.75 124.04-.29 26.29-7.37 52.46-21.88 71.71-9.45 12.54-21.58 22.79-36.12 30.91-13.99 7.84-30.33 13.8-48.66 18.05l-3.34.41a149.188 149.188 0 0 0 .7-31.28c13.69-3.49 25.85-8.07 36.26-13.88 10.96-6.13 19.92-13.59 26.62-22.54 10.42-13.88 15.55-33.5 15.75-53.62.57-47.23-26.49-92.88-78.29-93.21-14.29-.13-29.16 3.33-43.24 9.57zm-59.14 126.4v81.75l.02.18.02.1.04.4.04.32.04.79.02.18v.12l-.02.04c-.02 1.24-.21 2.49-.56 3.67-.34 1.18-.84 2.31-1.43 3.37-2.93 5.12-8.99 9.35-15.95 10.54-1.36.24-2.65.34-3.88.34-3.76 0-7.16-1.01-9.79-2.77-2.87-1.94-4.84-4.74-5.44-8.16l-.01.01v-.02c-.11-.7-.17-1.42-.17-2.12v-.11l.02-.04c.01-1.24.21-2.5.56-3.67.33-1.18.83-2.31 1.43-3.37 2.93-5.13 8.99-9.34 15.95-10.54l.1-.02.97-.15.22-.01.96-.08.17-.02.94-.04h.11v-38.16l-42.62 12.25v52.46l.02.26v.15l.02.46.02.1v.12l-.02.04a15.7 15.7 0 0 1-.64 4.19c-.4 1.31-.96 2.61-1.66 3.85-3.4 5.95-10.46 10.88-18.53 12.27-5.41.91-11.14.33-15.79-2.79-7.06-4.73-8-12.99-4.06-19.83 3.4-5.96 10.44-10.88 18.53-12.28h.05l.35-.06.04-.01c.42-.07.98-.14 1.74-.2.55-.06 1.13-.11 1.71-.11h.02c.9-.01 1.77.02 2.63.08V267.1l73.83-16z"/>
              </svg>
            </div>
            <div class="export-preset-title">Streaming Platform</div>
            <div class="export-preset-desc">Optimized for Spotify, Apple Music, SoundCloud. Targets -14 LUFS, minimal EQ, light compression (1.3:1), preserves dynamics. Professional streaming loudness.</div>
          </label>
        </div>
      </div>
    </div>
    
    <div class="export-dialog-footer">
      <button id="export-dialog-cancel" class="export-dialog-btn export-dialog-btn-secondary">Cancel</button>
      <button id="export-dialog-export" class="export-dialog-btn export-dialog-btn-primary">Export WAV</button>
    </div>
  </div>
</div>


  </div>

<!-- Load audio loops FIRST -->
<script defer src="assets/loops.js?v=2"></script>

<!-- Load MIDI loop definitions -->
<script defer src="assets/midis.js"></script>

<!-- Load engines -->
<script defer src="js/utils.js"></script>
<script defer src="js/midi/midi-synth-basic.js"></script>
<script defer src="js/midi/midi-synth-offline.js"></script>
<script defer src="js/midi/midi-engine.js"></script>
<script defer src="js/audioEngine.js"></script>

<!-- UI + clip classes -->
<script defer src="js/timeline.js"></script>
<script defer src="js/sidebar.js"></script>
<script defer src="js/midi/midi-clip.js"></script>

<!-- Tone.js MIDI parser -->
<script defer src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.js"></script>

<script defer src="js/midi/piano-roll.js"></script>


<!-- MAIN APP (must be last) -->
<script defer src="js/main.js"></script>

<script defer src="js/exportSong.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>


</body>
</html>